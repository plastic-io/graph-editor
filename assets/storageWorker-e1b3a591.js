(function(){"use strict";/*! (c) 2020 Andrea Giammarchi */const{parse:z,stringify:G}=JSON,{keys:Z}=Object,N=String,R="string",q={},g="object",H=(v,s)=>s,ee=v=>v instanceof N?N(v):v,te=(v,s)=>typeof s===R?new N(s):s,K=(v,s,a,o)=>{const l=[];for(let f=Z(a),{length:p}=f,y=0;y<p;y++){const c=f[y],m=a[c];if(m instanceof N){const h=v[m];typeof h===g&&!s.has(h)?(s.add(h),a[c]=q,l.push({k:c,a:[v,s,h,o]})):a[c]=o.call(a,c,h)}else a[c]!==q&&(a[c]=o.call(a,c,m))}for(let{length:f}=l,p=0;p<f;p++){const{k:y,a:c}=l[p];a[y]=o.call(a,y,K.apply(null,c))}return a},U=(v,s,a)=>{const o=N(s.push(a)-1);return v.set(a,o),o},ne=(v,s)=>{const a=z(v,te).map(ee),o=a[0],l=s||H,f=typeof o===g&&o?K(a,new Set,o,l):o;return l.call({"":f},"",f)},re=(v,s,a)=>{const o=s&&typeof s===g?(h,D)=>h===""||-1<s.indexOf(h)?D:void 0:s||H,l=new Map,f=[],p=[];let y=+U(l,f,o.call({"":v},"",v)),c=!y;for(;y<f.length;)c=!0,p[y]=G(f[y++],m,a);return"["+p.join(",")+"]";function m(h,D){if(c)return c=!c,D;const O=o.call(this,h,D);switch(typeof O){case g:if(O===null)return O;case R:return l.get(O)||U(l,f,O)}return O}},F=v=>z(re(v)),oe=v=>ne(G(v));var ie=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},L={exports:{}};(function(v,s){(function(a,o){var l=o(a);v.exports=l})(ie,function(a){var o=["N","E","A","D"];function l(t,n){t.super_=n,t.prototype=Object.create(n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}function f(t,n){Object.defineProperty(this,"kind",{value:t,enumerable:!0}),n&&n.length&&Object.defineProperty(this,"path",{value:n,enumerable:!0})}function p(t,n,e){p.super_.call(this,"E",t),Object.defineProperty(this,"lhs",{value:n,enumerable:!0}),Object.defineProperty(this,"rhs",{value:e,enumerable:!0})}l(p,f);function y(t,n){y.super_.call(this,"N",t),Object.defineProperty(this,"rhs",{value:n,enumerable:!0})}l(y,f);function c(t,n){c.super_.call(this,"D",t),Object.defineProperty(this,"lhs",{value:n,enumerable:!0})}l(c,f);function m(t,n,e){m.super_.call(this,"A",t),Object.defineProperty(this,"index",{value:n,enumerable:!0}),Object.defineProperty(this,"item",{value:e,enumerable:!0})}l(m,f);function h(t,n,e){var r=t.slice((e||n)+1||t.length);return t.length=n<0?t.length+n:n,t.push.apply(t,r),t}function D(t){var n=typeof t;return n!=="object"?n:t===Math?"math":t===null?"null":Array.isArray(t)?"array":Object.prototype.toString.call(t)==="[object Date]"?"date":typeof t.toString=="function"&&/^\/.*\//.test(t.toString())?"regexp":"object"}function O(t){var n=0;if(t.length===0)return n;for(var e=0;e<t.length;e++){var r=t.charCodeAt(e);n=(n<<5)-n+r,n=n&n}return n}function S(t){var n=0,e=D(t);if(e==="array"){t.forEach(function(x){n+=S(x)});var r="[type: array, hash: "+n+"]";return n+O(r)}if(e==="object"){for(var i in t)if(t.hasOwnProperty(i)){var d="[ type: object, key: "+i+", value hash: "+S(t[i])+"]";n+=O(d)}return n}var u="[ type: "+e+" ; value: "+t+"]";return n+O(u)}function E(t,n,e,r,i,d,u,x){e=e||[],i=i||[],u=u||[];var w=i.slice(0);if(typeof d<"u"&&d!==null){if(r){if(typeof r=="function"&&r(w,d))return;if(typeof r=="object"){if(r.prefilter&&r.prefilter(w,d))return;if(r.normalize){var B=r.normalize(w,d,t,n);B&&(t=B[0],n=B[1])}}}w.push(d)}D(t)==="regexp"&&D(n)==="regexp"&&(t=t.toString(),n=n.toString());var $=typeof t,ce=typeof n,b,A,j,I,W=$!=="undefined"||u&&u.length>0&&u[u.length-1].lhs&&Object.getOwnPropertyDescriptor(u[u.length-1].lhs,d),X=ce!=="undefined"||u&&u.length>0&&u[u.length-1].rhs&&Object.getOwnPropertyDescriptor(u[u.length-1].rhs,d);if(!W&&X)e.push(new y(w,n));else if(!X&&W)e.push(new c(w,t));else if(D(t)!==D(n))e.push(new p(w,t,n));else if(D(t)==="date"&&t-n!==0)e.push(new p(w,t,n));else if($==="object"&&t!==null&&n!==null){for(b=u.length-1;b>-1;--b)if(u[b].lhs===t){I=!0;break}if(I)t!==n&&e.push(new p(w,t,n));else{if(u.push({lhs:t,rhs:n}),Array.isArray(t)){for(x&&(t.sort(function(J,M){return S(J)-S(M)}),n.sort(function(J,M){return S(J)-S(M)})),b=n.length-1,A=t.length-1;b>A;)e.push(new m(w,b,new y(void 0,n[b--])));for(;A>b;)e.push(new m(w,A,new c(void 0,t[A--])));for(;b>=0;--b)E(t[b],n[b],e,r,w,b,u,x)}else{var Y=Object.keys(t),C=Object.keys(n);for(b=0;b<Y.length;++b)j=Y[b],I=C.indexOf(j),I>=0?(E(t[j],n[j],e,r,w,j,u,x),C[I]=null):E(t[j],void 0,e,r,w,j,u,x);for(b=0;b<C.length;++b)j=C[b],j&&E(void 0,n[j],e,r,w,j,u,x)}u.length=u.length-1}}else t!==n&&($==="number"&&isNaN(t)&&isNaN(n)||e.push(new p(w,t,n)))}function T(t,n,e,r,i){var d=[];if(E(t,n,d,r,null,null,null,i),e)for(var u=0;u<d.length;++u)e(d[u]);return d}function ue(t,n,e,r,i,d,u){return E(t,n,e,r,i,d,u,!0)}function P(t,n,e,r){var i=r?function(u){u&&r.push(u)}:void 0,d=T(t,n,i,e);return r||(d.length?d:void 0)}function le(t,n,e,r){var i=r?function(u){u&&r.push(u)}:void 0,d=T(t,n,i,e,!0);return r||(d.length?d:void 0)}function _(t,n,e){if(e.path&&e.path.length){var r=t[n],i,d=e.path.length-1;for(i=0;i<d;i++)r=r[e.path[i]];switch(e.kind){case"A":_(r[e.path[i]],e.index,e.item);break;case"D":delete r[e.path[i]];break;case"E":case"N":r[e.path[i]]=e.rhs;break}}else switch(e.kind){case"A":_(t[n],e.index,e.item);break;case"D":t=h(t,n);break;case"E":case"N":t[n]=e.rhs;break}return t}function V(t,n,e){if(typeof e>"u"&&n&&~o.indexOf(n.kind)&&(e=n),t&&e&&e.kind){for(var r=t,i=-1,d=e.path?e.path.length-1:0;++i<d;)typeof r[e.path[i]]>"u"&&(r[e.path[i]]=typeof e.path[i+1]<"u"&&typeof e.path[i+1]=="number"?[]:{}),r=r[e.path[i]];switch(e.kind){case"A":e.path&&typeof r[e.path[i]]>"u"&&(r[e.path[i]]=[]),_(e.path?r[e.path[i]]:r,e.index,e.item);break;case"D":delete r[e.path[i]];break;case"E":case"N":r[e.path[i]]=e.rhs;break}}}function k(t,n,e){if(e.path&&e.path.length){var r=t[n],i,d=e.path.length-1;for(i=0;i<d;i++)r=r[e.path[i]];switch(e.kind){case"A":k(r[e.path[i]],e.index,e.item);break;case"D":r[e.path[i]]=e.lhs;break;case"E":r[e.path[i]]=e.lhs;break;case"N":delete r[e.path[i]];break}}else switch(e.kind){case"A":k(t[n],e.index,e.item);break;case"D":t[n]=e.lhs;break;case"E":t[n]=e.lhs;break;case"N":t=h(t,n);break}return t}function de(t,n,e){if(t&&n&&e&&e.kind){var r=t,i,d;for(d=e.path.length-1,i=0;i<d;i++)typeof r[e.path[i]]>"u"&&(r[e.path[i]]={}),r=r[e.path[i]];switch(e.kind){case"A":k(r[e.path[i]],e.index,e.item);break;case"D":r[e.path[i]]=e.lhs;break;case"E":r[e.path[i]]=e.lhs;break;case"N":delete r[e.path[i]];break}}}function pe(t,n,e){if(t&&n){var r=function(i){(!e||e(t,n,i))&&V(t,n,i)};T(t,n,r)}}return Object.defineProperties(P,{diff:{value:P,enumerable:!0},orderIndependentDiff:{value:le,enumerable:!0},observableDiff:{value:T,enumerable:!0},orderIndependentObservableDiff:{value:ue,enumerable:!0},orderIndepHash:{value:S,enumerable:!0},applyDiff:{value:pe,enumerable:!0},applyChange:{value:V,enumerable:!0},revertChange:{value:de,enumerable:!0},isConflict:{value:function(){return typeof $conflict<"u"},enumerable:!0}}),P.DeepDiff=P,a&&(a.DeepDiff=P),P})})(L);var se=L.exports;const ae="plastic-io-document-provider";class fe{open(){return new Promise(s=>{const a=self.indexedDB.open(ae,1);a.onupgradeneeded=o=>{const l=o.target.result;l.createObjectStore("events",{keyPath:"id"}).createIndex("documentId","documentId",{unique:!1}),l.createObjectStore("documents",{keyPath:"id"})},a.onerror=o=>{throw new Error("Error opening/creating IndexedDB"+o)},a.onsuccess=o=>{s(o.target.result)}})}deleteEvents(s){return new Promise(async(a,o)=>{const f=(await this.open()).transaction("events","readwrite"),y=f.objectStore("events").index("documentId");y.openCursor(IDBKeyRange.only(s)).onsuccess=c=>{const m=c.target.result;m?(m.delete(),m.continue()):a(null)},f.oncomplete=()=>{this.updateToc(s,"update")}})}getEvents(s){return new Promise(async(a,o)=>{const l=[],c=(await this.open()).transaction("events","readonly").objectStore("events").index("documentId");c.openCursor(IDBKeyRange.only(s)).onsuccess=m=>{const h=m.target.result;h?(l.push(h.value),h.continue()):a(l)}})}async set(s,a,o){const l=await this.open();let f=a;if(o==="update"){const p=l.transaction("events","readwrite");p.oncomplete=()=>{this.updateToc(s,o)},f.documentId=s,p.objectStore("events").add(f)}else if(o==="artifact"){const p=l.transaction("documents","readwrite");p.oncomplete=()=>{this.updateToc(f.id,o)},f=f.graph,f.id=`${f.id}.${f.version}`,p.objectStore("documents").add(f)}else throw new Error("Set called without a recognized type")}async fetchItem(s,a){return new Promise(async(o,l)=>{const c=(await this.open()).transaction(s,"readonly").objectStore(s).get(a);c.onsuccess=()=>{c.result?o(c.result):o(null)},c.onerror=()=>{l(c.error)}})}async getToc(){return await this.fetchItem("documents","toc")||{id:"toc"}}async updateToc(s,a){let o;try{o=await this.get(s,a)}catch{}const l=await this.open(),f=await this.getToc(),p=l.transaction("documents","readwrite");o=o.graph?o.graph:o,o?(a=a==="update"?"graph":"publishedGraph",f[s]={description:o.properties.description,icon:o.properties.icon,id:o.id,url:o.url,lastUpdate:o.properties.lastUpdate,name:o.properties.name,type:a,version:o.version}):delete f[s],p.oncomplete=()=>{postMessage({source:"toc-update",event:F({toc:f,graph:o})})},p.objectStore("documents").put(f)}async projectGraphEvents(s){const a=performance.now(),o=await this.getEvents(s);if(o.length===0)return null;const l={};return o.sort((f,p)=>f.version-p.version).forEach(f=>{f.changes.forEach(p=>{se.applyChange(l,!0,p)})}),console.debug(`Projected graph from ${o.length} events in ${performance.now()-a}ms`),l}async get(s,a){if(s==="toc.json")return await this.getToc();if(a==="artifact")return await this.fetchItem("documents",s);const o=await this.projectGraphEvents(s);return JSON.parse(JSON.stringify(o))}async delete(s){await this.deleteEvents(s)}}const Q=new fe;onmessage=async v=>{const s=v.data.id,a=oe(v.data.args),o=v.data.method,l=await Q[o].apply(Q,a);postMessage({source:s,event:F(l)})}})();
